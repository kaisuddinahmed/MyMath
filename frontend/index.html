<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MyMath Parent App</title>
  <style>
    :root {
      --bg-a: #f9fbff;
      --bg-b: #eef9f4;
      --card: #ffffff;
      --ink: #1f2937;
      --muted: #5b6b80;
      --accent: #1f7aec;
      --accent-soft: #dbeafe;
      --warm: #ffecd6;
      --ok: #169c5a;
      --danger: #b42318;
      --radius: 18px;
      --shadow: 0 14px 30px rgba(30, 64, 175, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Nunito", "Avenir Next", "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at top right, #dbeafe 0%, transparent 45%),
        radial-gradient(circle at bottom left, #dcfce7 0%, transparent 40%),
        linear-gradient(135deg, var(--bg-a), var(--bg-b));
    }

    .app {
      max-width: 920px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    .shell {
      background: var(--card);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid #e6edff;
    }

    .topbar {
      padding: 14px 18px;
      background: #f8fbff;
      border-bottom: 1px solid #e6edff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand {
      font-size: 1.15rem;
      font-weight: 900;
      letter-spacing: 0.3px;
    }

    .chip {
      font-size: 0.86rem;
      color: var(--muted);
      background: #eef3ff;
      padding: 8px 12px;
      border-radius: 999px;
    }

    .screen {
      display: none;
      padding: 22px;
    }

    .screen.active {
      display: block;
    }

    h1 {
      margin: 0 0 8px;
      font-size: clamp(1.35rem, 2.2vw, 1.9rem);
    }

    .sub {
      margin: 0 0 18px;
      color: var(--muted);
      font-size: 1rem;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .field label {
      font-size: 0.92rem;
      color: #334155;
      font-weight: 700;
    }

    input, select, textarea {
      width: 100%;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      background: #fff;
      transition: border-color 0.15s ease;
    }

    textarea {
      min-height: 150px;
      resize: vertical;
      font-size: 1.15rem;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #7aa6ff;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }

    button {
      border: 0;
      border-radius: 14px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 800;
      padding: 13px 18px;
      cursor: pointer;
      transition: transform 0.1s ease, filter 0.1s ease;
    }

    button:active {
      transform: translateY(1px);
    }

    .btn-main {
      background: var(--accent);
      color: #fff;
      min-height: 50px;
    }

    .btn-main:hover { filter: brightness(1.05); }

    .btn-soft {
      background: var(--accent-soft);
      color: #1e3a8a;
    }

    .btn-warm {
      background: var(--warm);
      color: #7c2d12;
    }

    .btn-danger {
      background: #fee2e2;
      color: #7f1d1d;
    }

    .card-list {
      display: grid;
      gap: 10px;
    }

    .child-card {
      border: 1px solid #e2e8f0;
      border-radius: var(--radius);
      padding: 14px;
      display: grid;
      gap: 8px;
      background: #fff;
    }

    .child-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .child-title {
      font-size: 1.1rem;
      font-weight: 900;
    }

    .muted {
      color: var(--muted);
      font-size: 0.92rem;
    }

    .panel {
      border: 1px solid #e2e8f0;
      border-radius: var(--radius);
      background: #f8fbff;
      padding: 14px;
    }

    .status {
      margin-top: 10px;
      min-height: 20px;
      font-weight: 700;
      font-size: 0.95rem;
    }

    .status.ok { color: var(--ok); }
    .status.err { color: var(--danger); }

    .video-wrap {
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #dbe3ef;
      background: #0f172a;
      margin-top: 10px;
    }

    video {
      width: 100%;
      display: block;
    }

    .score {
      display: inline-block;
      background: #d1fae5;
      color: #065f46;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 900;
    }

    @media (max-width: 680px) {
      .screen { padding: 16px; }
      button { width: 100%; }
      .actions { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="shell">
      <header class="topbar">
        <div class="brand">MyMath Parent App</div>
        <div class="chip" id="apiChip">API: http://127.0.0.1:1234</div>
      </header>

      <section class="screen active" id="screen-auth">
        <h1>Parent Login / Signup</h1>
        <p class="sub">Simple start. Email + password only.</p>
        <div class="grid">
          <div class="field">
            <label for="parentEmail">Email</label>
            <input id="parentEmail" type="email" placeholder="parent@email.com" />
          </div>
          <div class="field">
            <label for="parentPass">Password</label>
            <input id="parentPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>
          <div class="actions">
            <button class="btn-main" id="btnLogin">Continue</button>
            <button class="btn-soft" id="btnUseSaved">Use Saved Session</button>
          </div>
          <div class="status" id="authStatus"></div>
        </div>
      </section>

      <section class="screen" id="screen-add-child">
        <h1>Add Child Profile</h1>
        <p class="sub">Name, age, class, avatar (optional).</p>
        <div class="grid">
          <div class="field">
            <label for="childName">Child Name</label>
            <input id="childName" placeholder="Ayaan" />
          </div>
          <div class="field">
            <label for="childAge">Age</label>
            <input id="childAge" type="number" min="4" max="12" value="7" />
          </div>
          <div class="field">
            <label for="childClass">Class</label>
            <select id="childClass">
              <option value="1">Class 1</option>
              <option value="2" selected>Class 2</option>
              <option value="3">Class 3</option>
              <option value="4">Class 4</option>
              <option value="5">Class 5</option>
            </select>
          </div>
          <div class="field">
            <label for="childAvatar">Avatar (optional emoji)</label>
            <input id="childAvatar" placeholder="ðŸ§ " />
          </div>
          <div class="actions">
            <button class="btn-main" id="btnCreateChild">Create Child</button>
            <button class="btn-soft" id="btnSkipToHome">Go Home</button>
          </div>
          <div class="status" id="childStatus"></div>
        </div>
      </section>

      <section class="screen" id="screen-home">
        <h1>Home (Parent View)</h1>
        <p class="sub">Choose a child, ask a question, view recent activity.</p>
        <div class="actions">
          <button class="btn-main" id="btnAskQuestion">Ask a Math Question</button>
          <button class="btn-soft" id="btnAddChildAgain">Add Child</button>
          <button class="btn-warm" id="btnRefreshHome">Refresh</button>
        </div>

        <div style="height: 12px;"></div>
        <h3 style="margin: 0 0 8px;">Child Cards</h3>
        <div class="card-list" id="childCards"></div>

        <div style="height: 14px;"></div>
        <h3 style="margin: 0 0 8px;">Recent Activity</h3>
        <div class="panel">
          <div class="card-list" id="activityList"></div>
        </div>
      </section>

      <section class="screen" id="screen-solve">
        <h1>Child Solve Screen</h1>
        <p class="sub" id="solveChildLine">Selected child: -</p>
        <div class="grid">
          <div class="field">
            <label for="questionInput">Question</label>
            <textarea id="questionInput" placeholder="Type: 12 + 5"></textarea>
          </div>
          <div class="actions">
            <button class="btn-soft" id="btnCamera">Camera Scan (placeholder)</button>
            <button class="btn-main" id="btnExplainVideo">Explain With Video</button>
            <button class="btn-danger" id="btnBackHome">Back</button>
          </div>
          <div class="status" id="solveStatus"></div>
        </div>
      </section>

      <section class="screen" id="screen-result">
        <h1>Result Screen</h1>
        <p class="sub">Answer + generated teaching video.</p>
        <div class="panel">
          <div id="resultAnswer" style="font-size: 1.6rem; font-weight: 900;">Answer: -</div>
          <div class="muted" id="resultMeta" style="margin-top: 6px;">Topic: -</div>
          <div style="margin-top: 8px;"><span class="score" id="resultScore">Score: -</span></div>
        </div>
        <div class="video-wrap">
          <video id="resultVideo" controls></video>
        </div>
        <div class="actions" style="margin-top: 12px;">
          <button class="btn-main" id="btnTrySimilar">Try Similar Question</button>
          <button class="btn-soft" id="btnResultHome">Home</button>
        </div>
        <div class="status" id="resultStatus"></div>
      </section>
    </div>
  </div>

  <script>
    const API_BASE = localStorage.getItem("mymath_api_base") || "http://127.0.0.1:1234";
    document.getElementById("apiChip").textContent = `API: ${API_BASE}`;

    const state = {
      parentEmail: localStorage.getItem("mymath_parent_email") || "",
      children: [],
      selectedChildId: localStorage.getItem("mymath_selected_child_id") || "",
      lastQuestion: "",
      lastResult: null
    };

    const screens = ["auth", "add-child", "home", "solve", "result"];
    function showScreen(name) {
      for (const s of screens) {
        const el = document.getElementById(`screen-${s}`);
        el.classList.toggle("active", s === name);
      }
    }

    async function api(path, method = "GET", payload = null) {
      const opts = { method, headers: {} };
      if (payload !== null) {
        opts.headers["Content-Type"] = "application/json";
        opts.body = JSON.stringify(payload);
      }
      const res = await fetch(`${API_BASE}${path}`, opts);
      const body = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(body.detail || `HTTP ${res.status}`);
      }
      return body;
    }

    function setStatus(id, message, kind = "") {
      const el = document.getElementById(id);
      el.textContent = message || "";
      el.classList.remove("ok", "err");
      if (kind) el.classList.add(kind);
    }

    function getSelectedChild() {
      return state.children.find(c => c.child_id === state.selectedChildId) || null;
    }

    function similarQuestion(q) {
      const text = (q || "").trim();
      if (text.includes("+")) return "8 + 6";
      if (text.includes("-")) return "14 - 5";
      if (text.includes("x") || text.includes("X") || text.includes("*")) return "5 x 4";
      if (text.includes("Ã·") || text.includes("/")) return "18 Ã· 3";
      if (text.toLowerCase().includes("1/4")) return "1/4 of 16";
      return "12 + 5";
    }

    async function loadChildren() {
      state.children = await api("/children");
      if (!state.selectedChildId && state.children.length > 0) {
        state.selectedChildId = state.children[0].child_id;
        localStorage.setItem("mymath_selected_child_id", state.selectedChildId);
      }
      renderChildren();
    }

    function renderChildren() {
      const host = document.getElementById("childCards");
      host.innerHTML = "";
      if (state.children.length === 0) {
        host.innerHTML = `<div class="muted">No child yet. Add one first.</div>`;
        return;
      }
      for (const c of state.children) {
        const card = document.createElement("div");
        card.className = "child-card";
        const active = c.child_id === state.selectedChildId ? " (selected)" : "";
        card.innerHTML = `
          <div class="child-row">
            <div>
              <div class="child-title">${c.child_name}${active}</div>
              <div class="muted">Age ${c.age} â€¢ Class ${c.class_level}</div>
            </div>
            <button class="btn-main" data-id="${c.child_id}">Use Child</button>
          </div>
        `;
        host.appendChild(card);
      }
      host.querySelectorAll("button[data-id]").forEach(btn => {
        btn.addEventListener("click", () => {
          state.selectedChildId = btn.getAttribute("data-id");
          localStorage.setItem("mymath_selected_child_id", state.selectedChildId);
          renderChildren();
          setStatus("solveStatus", "", "");
        });
      });
    }

    async function loadActivity() {
      const list = document.getElementById("activityList");
      list.innerHTML = "Loading...";
      try {
        const records = await api("/activity?limit=10");
        if (!records.length) {
          list.innerHTML = `<div class="muted">No activity yet.</div>`;
          return;
        }
        list.innerHTML = "";
        for (const r of records) {
          const row = document.createElement("div");
          row.className = "child-card";
          row.innerHTML = `
            <div class="child-row">
              <div>
                <div style="font-weight:800">${r.question}</div>
                <div class="muted">${r.topic} â€¢ ${r.template} â€¢ score ${r.score}</div>
              </div>
              <div class="muted">${new Date(r.timestamp).toLocaleString()}</div>
            </div>
          `;
          list.appendChild(row);
        }
      } catch (err) {
        list.innerHTML = `<div class="muted">Could not load activity: ${err.message}</div>`;
      }
    }

    function goToSolve() {
      const child = getSelectedChild();
      if (!child) {
        setStatus("authStatus", "Create/select a child first.", "err");
        showScreen("add-child");
        return;
      }
      document.getElementById("solveChildLine").textContent = `Selected child: ${child.child_name} (Class ${child.class_level})`;
      document.getElementById("questionInput").value = state.lastQuestion || "12 + 5";
      setStatus("solveStatus", "", "");
      showScreen("solve");
    }

    async function explainWithVideo() {
      const child = getSelectedChild();
      const question = document.getElementById("questionInput").value.trim();
      if (!child) {
        setStatus("solveStatus", "Select a child first.", "err");
        return;
      }
      if (!question) {
        setStatus("solveStatus", "Enter a math question.", "err");
        return;
      }

      state.lastQuestion = question;
      setStatus("solveStatus", "Generating explanation JSON...", "ok");
      try {
        const solveData = await api("/solve-and-video-prompt/by-child", "POST", {
          child_id: child.child_id,
          question
        });

        if (!solveData.video_prompt_json || !solveData.schema_valid) {
          throw new Error("Prompt JSON invalid. Please try again.");
        }

        setStatus("solveStatus", "Rendering video...", "ok");
        const outputName = `child_${child.child_id.slice(0, 8)}_${Date.now()}.mp4`;
        const renderData = await api("/render-video", "POST", {
          video_prompt_json: solveData.video_prompt_json,
          output_name: outputName
        });

        const videoUrl = renderData.output_url.startsWith("http")
          ? renderData.output_url
          : `${API_BASE}${renderData.output_url}`;

        state.lastResult = {
          answer: solveData.verified_answer,
          topic: solveData.topic,
          template: solveData.template,
          score: solveData.final_score,
          videoUrl
        };
        renderResult();
        await loadActivity();
        showScreen("result");
      } catch (err) {
        setStatus("solveStatus", err.message, "err");
      }
    }

    function renderResult() {
      const r = state.lastResult;
      if (!r) return;
      document.getElementById("resultAnswer").textContent = `Answer: ${r.answer}`;
      document.getElementById("resultMeta").textContent = `Topic: ${r.topic} â€¢ Template: ${r.template}`;
      document.getElementById("resultScore").textContent = `Score: ${r.score}`;
      const video = document.getElementById("resultVideo");
      video.src = r.videoUrl;
      video.load();
      setStatus("resultStatus", "Video ready.", "ok");
    }

    document.getElementById("btnLogin").addEventListener("click", async () => {
      const email = document.getElementById("parentEmail").value.trim();
      const pass = document.getElementById("parentPass").value.trim();
      if (!email || !pass) {
        setStatus("authStatus", "Enter email and password.", "err");
        return;
      }
      state.parentEmail = email;
      localStorage.setItem("mymath_parent_email", email);
      setStatus("authStatus", "Session started.", "ok");
      try {
        await loadChildren();
        await loadActivity();
      } catch (err) {
        setStatus("authStatus", `Backend not reachable: ${err.message}`, "err");
      }
      showScreen(state.children.length ? "home" : "add-child");
    });

    document.getElementById("btnUseSaved").addEventListener("click", async () => {
      if (!state.parentEmail) {
        setStatus("authStatus", "No saved session found.", "err");
        return;
      }
      document.getElementById("parentEmail").value = state.parentEmail;
      try {
        await loadChildren();
        await loadActivity();
        showScreen(state.children.length ? "home" : "add-child");
      } catch (err) {
        setStatus("authStatus", `Backend not reachable: ${err.message}`, "err");
      }
    });

    document.getElementById("btnCreateChild").addEventListener("click", async () => {
      const child_name = document.getElementById("childName").value.trim();
      const age = Number(document.getElementById("childAge").value);
      const class_level = Number(document.getElementById("childClass").value);
      if (!child_name) {
        setStatus("childStatus", "Enter child name.", "err");
        return;
      }
      try {
        const child = await api("/children", "POST", { child_name, age, class_level });
        await loadChildren();
        state.selectedChildId = child.child_id;
        localStorage.setItem("mymath_selected_child_id", child.child_id);
        await loadActivity();
        setStatus("childStatus", "Child profile created.", "ok");
        showScreen("home");
      } catch (err) {
        setStatus("childStatus", err.message, "err");
      }
    });

    document.getElementById("btnSkipToHome").addEventListener("click", async () => {
      try {
        await loadChildren();
        await loadActivity();
      } catch (err) {
        setStatus("childStatus", `Backend not reachable: ${err.message}`, "err");
      }
      showScreen("home");
    });

    document.getElementById("btnAskQuestion").addEventListener("click", goToSolve);
    document.getElementById("btnAddChildAgain").addEventListener("click", () => showScreen("add-child"));
    document.getElementById("btnRefreshHome").addEventListener("click", async () => {
      await loadChildren();
      await loadActivity();
    });
    document.getElementById("btnBackHome").addEventListener("click", () => showScreen("home"));
    document.getElementById("btnResultHome").addEventListener("click", () => showScreen("home"));

    document.getElementById("btnCamera").addEventListener("click", () => {
      setStatus("solveStatus", "Camera scan is placeholder for now.", "ok");
    });

    document.getElementById("btnExplainVideo").addEventListener("click", explainWithVideo);

    document.getElementById("btnTrySimilar").addEventListener("click", () => {
      const similar = similarQuestion(state.lastQuestion);
      document.getElementById("questionInput").value = similar;
      showScreen("solve");
    });

    (async function boot() {
      if (state.parentEmail) {
        document.getElementById("parentEmail").value = state.parentEmail;
      }
      try {
        await loadChildren();
        await loadActivity();
      } catch (_) {
        // Keep auth screen if backend is offline.
      }
      if (state.parentEmail && state.children.length) {
        showScreen("home");
      }
    })();
  </script>
</body>
</html>

